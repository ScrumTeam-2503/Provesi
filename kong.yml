_format_version: "2.1"

services:
  - host: manejador_pedidos_upstream
    name: manejador_pedidos_service
    protocol: http
    routes:

      - name: manejador_pedidos
        paths:
          - /
          - /manejador_pedidos
        strip_path: false

  - host: manejador_inventario_upstream
    name: manejador_inventario_service
    protocol: http
    routes:

      - name: manejador_inventario
        paths:
          - /manejador_inventario
        strip_path: false

upstreams:
  - name: manejador_pedidos_upstream
    targets:
      - target: <manejador_pedidos_a>:8080
        weight: 100
      - target: <manejador_pedidos_b>:8080
        weight: 100
      - target: <manejador_pedidos_c>:8080
        weight: 100

    healthchecks:
      threshold: 50
      active:
        http_path: /health/
        timeout: 3
        healthy:
          successes: 2
          interval: 5
        unhealthy:
          tcp_failures: 2
          interval: 5

  - name: manejador_inventario_upstream
    targets:
      - target: <manejador_inventario_a>:8080
        weight: 100
      - target: <manejador_inventario_b>:8080
        weight: 100

    healthchecks:
      threshold: 50
      active:
        http_path: /health/
        timeout: 3
        healthy:
          successes: 2
          interval: 5
        unhealthy:
          tcp_failures: 2
          interval: 5

plugins:
  - name: response-transformer
    config:
      add:
        json:
          - 'message:"Servicio temporalmente no disponible, por favor intenta m√°s tarde."'
          - 'status:"degradado"'
      remove:
        headers:
          - Server
          - Via
